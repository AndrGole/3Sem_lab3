CXX = g++
CXXFLAGS = -std=c++17 -Wall -Wextra -I.
COV_FLAGS = --coverage
LDFLAGS = -lboost_unit_test_framework -lpthread -lgcov

PROGRAM = list_program
TEST_PROGRAM = list_tests
REPORT_DIR = coverage_report
LINT_FILES = ForwardList.h ForwardList.cpp Interface.cpp test.cpp

.PHONY: all program test coverage lint lint-quick lint-std clean_cov clean

all: program

program: ForwardList.cpp Interface.cpp
	$(CXX) $(CXXFLAGS) $^ -o $(PROGRAM)

test: test.cpp ForwardList.cpp
	$(CXX) $(CXXFLAGS) $^ -o $(TEST_PROGRAM) $(LDFLAGS)
	./$(TEST_PROGRAM) --catch_system_errors=no

bench: bench.cpp ForwardList.cpp
	g++ -std=c++17 -Wall -Wextra bench.cpp ForwardList.cpp -o list_bench \
		-lboost_unit_test_framework -lboost_chrono -lpthread
	./list_bench --catch_system_errors=no

coverage: clean_cov
	$(CXX) $(CXXFLAGS) $(COV_FLAGS) test.cpp ForwardList.cpp -o $(TEST_PROGRAM)_cov $(LDFLAGS)
	@./$(TEST_PROGRAM)_cov --catch_system_errors=no 2>/dev/null || echo "Тесты завершены (возможны ошибки)"
	@sleep 0.1
	@mkdir $(REPORT_DIR)
	@gcovr -r . --html --html-details --html-title "Coverage Report" --exclude-throw-branches -o $(REPORT_DIR)/index.html
	@echo " Отчёт: $(REPORT_DIR)/index.html"

lint:
	@echo "=== ПРОВЕРКА CLANG-TIDY ==="
	@if command -v clang-tidy >/dev/null 2>&1; then \
		for file in $(LINT_FILES); do \
			if [ -f "$$file" ]; then \
				echo "Анализ $$file..."; \
				clang-tidy $$file -- -std=c++17 $(CXXFLAGS); \
			fi; \
		done; \
	else \
		echo "clang-tidy не установлен. Установите: sudo pacman -S clang-tidy"; \
		exit 1; \
	fi

# Быстрая проверка только критических ошибок
lint-quick:
	@echo "=== БЫСТРАЯ ПРОВЕРКА ==="
	@clang-tidy ForwardList.cpp --checks='-*,bugprone*,clang-analyzer*' -- -std=c++17 2>/dev/null || true

# Стандартные проверки Google/LLVM
lint-std:
	@echo "=== СТАНДАРТНЫЕ ПРОВЕРКИ ==="
	@clang-tidy $(LINT_FILES) --checks='clang-analyzer-*,bugprone*,modernize*,performance*' -- -std=c++17

clean_cov:
	rm -f $(TEST_PROGRAM)_cov *.gcda *.gcno coverage.info
	rm -rf $(REPORT_DIR)

clean:
	rm -f $(PROGRAM) $(TEST_PROGRAM) $(TEST_PROGRAM)_cov *.gcda *.gcno coverage.info list_bench
	rm -rf $(REPORT_DIR) list.txt
